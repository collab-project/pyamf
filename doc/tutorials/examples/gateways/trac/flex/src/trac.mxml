<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   width="100%" height="100%">

	<s:layout>
		<s:VerticalLayout gap="10" verticalAlign="middle"
						  horizontalAlign="center" />
	</s:layout>
	
	<fx:Script>
		<![CDATA[
			import mx.utils.Base64Encoder;
			
			private var _connection 	: NetConnection;
			private var _responder		: Responder;
			private var _credentials	: Base64Encoder;
			
			protected function getApiVersion(event:MouseEvent):void
			{
				connect();
				
				_responder = new Responder( displayVersion, remoteFault );
				
				// call service
				_connection.call("system.getAPIVersion", _responder );
			}
			
			protected function getTickets(event:MouseEvent):void
			{
				connect();
				
				_responder = new Responder( displayTickets, remoteFault );
				
				// call service
				_connection.call("ticket.query", _responder, "max=0");
			}
			
			private function connect():void
			{
				if ( host_txt.text && username_txt.text && password_txt.text )
				{
					_credentials = new Base64Encoder();
					_credentials.encode( username_txt.text + ":" + password_txt.text );
					
					// connection
					_connection = new NetConnection();
					_connection.addEventListener( NetStatusEvent.NET_STATUS, onFault );
					_connection.addHeader("Authorization", true, "Basic " +
						                  _credentials.toString());
					_connection.connect( host_txt.text );
				}
			}
		
			private function displayVersion(re:*): void
			{
				if ( re is Array )
				{
					version.text = ( re as Array ).join( "." );
				}
				else
				{
					version.text = re;
				}
			}
			
			private function displayTickets(re:*): void
			{
				if ( re is Array )
				{
					tickets.text = "Found " + re.length + " ticket(s).";
				}
				else
				{
					tickets.text = re;
				}
			}
			
			private function onFault(fault:*): void
			{
				issue.text = fault.info.code;
			}
			
			private function remoteFault(fault:*): void
			{
				issue.text = fault.toString();
			}

		]]>
	</fx:Script>

	<s:Form>
		<s:layout>
			<s:FormLayout gap="-14"/>
		</s:layout>
		<s:FormItem label="Host">
			<s:TextInput id="host_txt" text="http://localhost:8000/login/amfrpc"
						 width="300"/>
		</s:FormItem>
		<s:FormItem label="Username">
			<s:TextInput id="username_txt" text="admin" width="300"/>
		</s:FormItem>
		<s:FormItem label="Password">
			<s:TextInput id="password_txt" text="admin" width="300"/>
		</s:FormItem>
	</s:Form>
	
	<s:HGroup verticalAlign="middle" gap="30">
		<s:Button label="Get API Version" click="getApiVersion(event)"/>
		
	    <s:RichText id="version" width="100%" fontSize="16" fontWeight="bold"
					textAlign="center" verticalAlign="middle" paddingTop="2"/>
	</s:HGroup>
	
	<s:HGroup verticalAlign="middle" gap="30">
		<s:Button label="Get Tickets" click="getTickets(event)"/>
		
		<s:RichText id="tickets" width="100%" fontSize="16" fontWeight="bold"
					textAlign="center" verticalAlign="middle" paddingTop="2"/>
	</s:HGroup>
	
	<s:RichText id="issue" width="100%" fontSize="14"
				textAlign="center" verticalAlign="middle"/>
	
</s:Application>
